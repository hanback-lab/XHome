# 실시간 모니터링 시스템 구현 

## 나만의 XHome Controller 
'3-3. GUI' 내용을 바탕으로 XHome 제어 프로그램을 작성해 보겠습니다. 작성할 프로그램에 필수로 적용되어야 하는 내용은 다음과 같습니다. 
>- 센서 데이터 
>    - 표기할 센서 목록
>        - Pir, Reed, Light, Temperature, Humidity, Dust
>    - 센서 데이터 갱신 주기는 1초 
>- 액츄에이터 
>    - Lamp 
>        - 동작 시킬 Lamp 위치 선택 후 On 또는 Off 버튼에 따른 제어 
>    - DoorLock    
>        - Open 또는 Close 버튼 제어에 따른 제어 

### UI 구성
앞서 작성한 숫자 맞추기 게임의 UI 구성은 별도의 UI 구성툴을 활용하지 않고 코드로 직접 하나씩 작성한 형태로 위젯의 배치를 좌표로 하나씩 지정해야 하기에 수정하기에 불편한점이 있습니다. 이번에는 Qt에서 UI 구성을 위해 제공하는 Qt Designer 를 활용하여 별도의 코드를 작성하지 않고 UI 배치를 진행 해보겠습니다. 

Qt Designer는 PySdie6를 설치할때 함께 설치되며 다음 명령을 통해 실행할 수 있습니다. 
```sh
pyside6-designer 
```

![Qt Designer](res/qt-designer.png)

Qt Designer는 UI 환경에서 원하는 위젯을 선택적으로 드래그&드롭 을 통해 배치하고 크기를 조정할 수 있습니다. 앞서 코드를 통해 작성하는 방법 보다는 보다 수월하고 빠르게 UI를 구성할 수 있습니다. 

새로운 UI 생성을 진행합니다. 생성할 UI는 Templates를 선택합니다. "Main Window" 를 선택하면 기본적인 창 구성이 가능합니다. 다음은 XHome Controller UI 구성입니다. 

![XHome Controller UI](res/xhome_controller_ui.png)

앞의 그림에 표기된 UI 에는 눈으로 확인되지 않는 Label을 포함하여 14개의 Label과 4개의 PushButton, 1개의 ComboBox로 이루어집니다. 각각의 위젯의 기본값 설정은 다음과 같습니다. 

**여기서 Geometry 는 꼭 아래의 내용을 따르지 않아도 되며 원하는대로 구성해도 관계 없습니다.**

| Class | Object Name | Description | Geometry | Default Value | 
|:-------|:------|:------|:------|:------|
| QLabel | PirLbl | 문자 표기 | [(20,20),41x41] | Pir |
| QLabel | PirValueLbl | 센서 데이터 표기 | [(70,20),81x41] | --- |
| QLabel | ReedLbl | 문자 표기 | [(180,20),41x41] | Reed |
| QLabel | ReedValueLbl | 센서 데이터 표기 | [(240,20),81x41] | --- |
| QLabel | LightLbl | 문자 표기 | [(340,20),41x41] | Light |
| QLabel | LightValueLbl | 센서 데이터 표기 | [(390,20),81x41] | --- |
| QLabel | TempLbl | 문자 표기 | [(20,70),101x41] | Temperature |
| QLabel | TempValueLbl | 센서 데이터 표기 | [(130,70),101x41] | --- |
| QLabel | HumiLbl | 문자 표기 | [(260,70),71x41] | Humidity |
| QLabel | HumiValueLbl | 센서 데이터 표기 | [(340,70),101x41] | --- |
| QLabel | DustLbl | 문자 표기 | [(20,120),61x41] | Dust |
| QLabel | DustValueLbl | 센서 데이터 표기 | [(110,120),291x41] | --- |
| QLabel | LampLbl | 문자 표기 | [(20,170),91x41] | Lamp |
| QComboBox | LampCB | 제어 위치 선택 | [(120,170),111x41] | --- |
| QPushButton | LampOnBtn | 램프 켜기 | [(250,170),111x41] | ON |
| QPushButton | LampOffBtn | 램프 끄기 | [(370,170),111x41] | OFF |
| QLabel | DoorLbl | 문자 표기 | [(20,230),91x41] | DoorLock |
| QPushButton | dOpenBtn | 도어락 열기 | [(120,230),111x41] | OPEN |
| QPushButton | dCloseBtn | 도어락 닫기 | [(250,230),111x41] | CLOSE |

작성한 파일을 Remote.ui 로 저장합니다. .ui 확장자를 사용하는 파일은 Qt Designer로 만든 GUI 레이아웃을 저장하는 XML 형식의 파일입니다. 파이썬 코드를 작성하지 않고 UI의 구성 요소를 설계하고 저장할 수 있습니다. .ui 파일은 파이썬 파일로 변환하여 사용합니다. 변환툴은 PySide6를 설치할때 함께 설치되며 변환 명령은 다음과 같습니다. 
```sh
pyside6-uic <file_name>.ui -o <file_name2>.py
```

작성한 Remote.ui 파일을 변환하게되면 다음과 명령으로 파이썬 파일로 변환할 수 있습니다. 
```sh
pyside6-uic Remote.ui -o Remote.py 
```

이렇게 생성된 UI 관련 파이썬 파일은 파일을 직접 수정해서 활용도 가능하지만 UI 구성의 편의와 작업 시간 단축을 위해 Qt Designer를 활용하는것을 추천합니다. 이제 이 파일을 어플리케이션 프로그램에서 import 해서 활용하면 됩니다. 

### XHome Controller 어플리케이션  
UI 파일을 기반으로 동작 코드를 구현합니다. 센서 데이터 자동 갱신을 위해 타이머를 구성하고 램프 및 도어락 제어를 위한 버튼의 동작을 정의합니다. 램프의 경우 위치 선택을 위해 ComboBox를 구성하고 ComboBox의 아이템을 ["entrance","livingroom","kitchen","room","bathroom"] 으로 설정합니다. 

```python
import sys
from PySide6.QtWidgets import QApplication, QMainWindow
from PySide6.QtCore import QTimer 
from Remote import Ui_MainWindow
from xhome.sensors import Pir, Reed, Light, Tphg, Dust
from xhome.actuator import Lamp, DoorLock

class Window(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        self.__pir = Pir()
        self.__reed = Reed()
        self.__light = Light()
        self.__tphg = Tphg()
        self.__dust = Dust() 
        self.__lamp = Lamp() 
        self.__doorlock = DoorLock() 
        self.ui.LampCB.addItems(["enterace","livingroom","kitchen","room","bathroom"])
        self.ui.dOpenBtn.clicked.connect(self.doorlock_clicked)
        self.ui.dCloseBtn.clicked.connect(self.doorlock_clicked)
        self.ui.LampOnBtn.clicked.connect(self.lamp_clicked)
        self.ui.LampOffBtn.clicked.connect(self.lamp_clicked)
        self.timer = QTimer(self)
        self.timer.setInterval(1000)
        self.timer.timeout.connect(self.sensor_update)
        self.timer.start()

    def sensor_update(self):
        self.ui.PirValueLbl.setText(self.__pir.read())
        self.ui.ReedValueLbl.setText(self.__reed.read())
        self.ui.LightValueLbl.setText(str(self.__light.read()))
        temp = self.__tphg.read()
        self.ui.TempValueLbl.setText(str(temp['temperature']))
        self.ui.HumiValueLbl.setText(str(temp['humidity']))
        temp = self.__dust.read()
        self.ui.DustValueLbl.setText("1.0 : "+str(temp['1.0'])+", 2.5 : "+str(temp['2.5'])+", 10 : "+str(temp['10']))
    
    def lamp_clicked(self):
        if self.sender().text() == "ON":
            self.__lamp.on(self.ui.LampCB.currentText())
        else:
            self.__lamp.off(self.ui.LampCB.currentText())

    def doorlock_clicked(self):
        if self.sender().text() == "OPEN":
            self.__doorlock.open()
        else:
            self.__doorlock.close()

app = QApplication(sys.argv)
window = Window()
window.show()
app.exec()
```

![XHome Controller](res/xhome_controller.png)

## 상태 알림 시스템 구현 
 